<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Balta Escanear v5</title>
    
    <meta name="theme-color" content="#020617">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Balta Scan">
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/jesusvn1993mplvt3-ai/Planificador/refs/heads/main/Balta.png">
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/jesusvn1993mplvt3-ai/Planificador/refs/heads/main/Balta.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        body { margin: 0; background: #020617; font-family: 'Inter', sans-serif; overflow: hidden; color: white; overscroll-behavior: none; }
        .glass-card { background: rgba(255, 255, 255, 0.08); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .glass-card:active { transform: scale(0.98); background: rgba(255, 255, 255, 0.15); }
        
        .fixed-header-container {
            position: fixed; top: 0; left: 0; width: 100%; z-index: 100;
            background: rgba(2, 6, 23, 0.95); backdrop-filter: blur(12px);
            padding: 10px 0; display: flex; justify-content: center;
            border-bottom: 1px solid rgba(255, 0, 0, 0.15);
        }
        .header-logo-img { height: 50px; width: auto; object-fit: contain; filter: drop-shadow(0 0 8px rgba(255,0,0,0.3)); }
        
        .red-light-scanner {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 3px;
            background: linear-gradient(90deg, transparent 0%, #ff0000 50%, transparent 100%);
            box-shadow: 0 0 20px 5px rgba(255, 0, 0, 0.7);
            animation: scanMove 2.5s infinite linear;
        }
        @keyframes scanMove { 0% { transform: translateX(-100%); opacity: 0; } 10% { opacity: 1; } 90% { opacity: 1; } 100% { transform: translateX(100%); opacity: 0; } }

        .drawer-overlay { background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); }
        .drawer-content { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); background: #0f172a; border-left: 1px solid #1e293b; }
        
        .preview-card {
            display: flex; height: 130px; border-radius: 12px; overflow: hidden; 
            background: #1e293b; border: 1px solid #334155; 
        }
        .preview-img-col { width: 35%; height: 100%; position: relative; background: #000; overflow: hidden; }
        .preview-img-col img { width: 100%; height: 100%; object-fit: cover; }
        .preview-data-col { width: 65%; padding: 10px; display: flex; flex-direction: column; justify-content: space-between; }

        #reader { width: 100% !important; border: none !important; height: 100% !important; }
        #reader video { object-fit: cover !important; width: 100% !important; height: 100% !important; border-radius: 12px; }
        
        .scan-window { 
            height: 150px; width: 100%; border: 2px solid #0ea5e9; border-radius: 16px; 
            overflow: hidden; position: relative; background: #000;
        }
        .scan-laser { 
            position: absolute; width: 100%; height: 2px; background: #38bdf8; 
            box-shadow: 0 0 15px #38bdf8; 
            animation: laserMove 2s infinite linear; z-index: 10; top: 0;
        }
        @keyframes laserMove { 0% { top: 0%; } 50% { top: 100%; } 100% { top: 0%; } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Configuración Firebase (Omitida por brevedad, usa la tuya)
        const firebaseConfig = {
            apiKey: "AIzaSyBqHgV4vDat1-VmZfKbiPg7nuiX-ROcexw",
            authDomain: "cirineo-cec21.firebaseapp.com",
            projectId: "cirineo-cec21",
            storageBucket: "cirineo-cec21.firebasestorage.app",
            messagingSenderId: "620210618284",
            appId: "1:620210618284:web:482bab9bf74650fff18409"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const FieldValue = firebase.firestore.FieldValue;

        const SUCCESS_SOUND_URL = "https://github.com/jesusvn1993mplvt3-ai/TejidoBalta/raw/refs/heads/main/Data/author.mp3";
        const successAudio = new Audio(SUCCESS_SOUND_URL);

        const Icon = ({ name, size = 24, className, onClick }) => {
            const ref = useRef(null);
            useEffect(() => {
                if (ref.current && lucide.icons[name]) {
                    ref.current.innerHTML = lucide.icons[name].toSvg({ width: size, height: size, class: className });
                }
            }, [name, className, size]);
            return <span ref={ref} onClick={onClick} className={`inline-flex items-center justify-center ${onClick ? 'cursor-pointer' : ''}`}></span>;
        };

        // --- COMPONENTE BOTÓN INSTALAR ---
        const InstallButton = () => {
            const [deferredPrompt, setDeferredPrompt] = useState(null);
            const [isVisible, setIsVisible] = useState(false);

            useEffect(() => {
                window.addEventListener('beforeinstallprompt', (e) => {
                    e.preventDefault();
                    setDeferredPrompt(e);
                    setIsVisible(true);
                });

                window.addEventListener('appinstalled', () => {
                    setIsVisible(false);
                    setDeferredPrompt(null);
                });
            }, []);

            const handleInstall = async () => {
                if (!deferredPrompt) return;
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    setIsVisible(false);
                    setDeferredPrompt(null);
                }
            };

            if (!isVisible) return null;

            return (
                <button 
                    onClick={handleInstall}
                    className="fixed bottom-6 left-6 right-6 bg-blue-600 hover:bg-blue-500 text-white py-4 rounded-2xl font-black text-sm flex items-center justify-center gap-3 shadow-2xl shadow-blue-900/40 animate-bounce z-[400] border border-blue-400/30"
                >
                    <Icon name="download" size={20}/>
                    INSTALAR APP EN CELULAR
                </button>
            );
        };

        // ... (Componentes SmartImage, PreviewDrawer y QuickScannerModal se mantienen igual que la v4)

        const SmartImage = ({ modelo }) => {
            const BASE_URL = "https://raw.githubusercontent.com/sweaters-liliana/MAES26/refs/heads/main/IMAGENES/PAPELETAS/";
            const [src, setSrc] = useState(`${BASE_URL}${modelo}.png`);
            const [errorCount, setErrorCount] = useState(0);
            const handleError = () => { if (errorCount === 0) { setSrc(`${BASE_URL}${modelo}.jpg`); setErrorCount(1); } else { setSrc(null); } };
            if (!src) return <div className="w-full h-full flex items-center justify-center text-slate-600 text-[10px] font-bold bg-slate-900 uppercase">Sin Foto</div>;
            return <img src={src} onError={handleError} alt={modelo} />;
        };

        const PreviewDrawer = ({ isOpen, onClose, pendingScans, ordersCache }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[300] flex justify-end drawer-overlay" onClick={onClose}>
                    <div className="w-full max-w-sm h-full drawer-content flex flex-col shadow-2xl border-l-2 border-blue-500/30" onClick={e => e.stopPropagation()}>
                        <div className="bg-[#020617] p-4 border-b border-slate-800 flex justify-between items-center">
                            <div>
                                <h2 className="text-white font-black text-xl flex items-center gap-2">
                                    <Icon name="list-checks" className="text-blue-500"/> CONSOLIDADOR
                                </h2>
                                <p className="text-[10px] text-slate-400 font-bold uppercase tracking-widest">{pendingScans.length} PENDIENTES</p>
                            </div>
                            <button onClick={onClose} className="p-2 bg-slate-800 rounded-full text-white"><Icon name="x" size={20}/></button>
                        </div>
                        <div className="flex-1 overflow-y-auto p-4 space-y-4 bg-[#0f172a]">
                            {pendingScans.map(scan => {
                                const order = ordersCache.find(o => String(o.id) === String(scan.orderId));
                                return (
                                    <div key={scan.id} className="preview-card animate-fade-in">
                                        <div className="preview-img-col"><SmartImage modelo={scan.modelo} /></div>
                                        <div className="preview-data-col">
                                            <div className="flex justify-between items-start border-b border-slate-700/50 pb-1">
                                                <span className="font-mono font-black text-lg text-white">{scan.codigo_paquete}</span>
                                                <span className="bg-blue-600 text-[9px] px-1.5 py-0.5 rounded font-bold">Pqt {scan.paquete_indice}</span>
                                            </div>
                                            <div className="grid grid-cols-2 gap-1 text-[11px]">
                                                <span className="text-slate-500 font-bold uppercase italic">{scan.modelo}</span>
                                                <span className="text-right text-yellow-400 font-black">{order?.maquina || '??'}</span>
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                </div>
            );
        };

        const QuickScannerModal = ({ isVisible, onClose, ordersCache, onScanSaved }) => {
            const [scans, setScans] = useState([]);
            const [isSaving, setIsSaving] = useState(false);
            const html5QrCodeRef = useRef(null);
            
            useEffect(() => {
                if (isVisible) { startScanner(); } else { stopScanner(); }
                return () => stopScanner();
            }, [isVisible]);

            const startScanner = async () => {
                try {
                    const html5QrCode = new Html5Qrcode("reader");
                    html5QrCodeRef.current = html5QrCode;
                    await html5QrCode.start({ facingMode: "environment" }, { fps: 15, qrbox: { width: 250, height: 100 } }, 
                        (decodedText) => {
                            const cleanCode = decodedText.trim().toUpperCase();
                            if (scans.some(s => s.code === cleanCode)) return;
                            
                            let found = null;
                            ordersCache.forEach(o => {
                                const p = o.progreso?.find(p => p.codigoUnico === cleanCode);
                                if (p) found = { code: cleanCode, orderId: o.id, modelo: o.codigo, partida: o.partida, paquete_indice: p.paqueteNum, paquete_total: p.paquetesDePieza, piezas_en_paquete: p.cantidad, tejedor: "Balta" };
                            });

                            if (found) {
                                successAudio.play();
                                setScans(prev => [found, ...prev]);
                            }
                        }, () => {});
                } catch (e) {}
            };

            const stopScanner = async () => { if (html5QrCodeRef.current) { await html5QrCodeRef.current.stop(); html5QrCodeRef.current = null; } };

            const save = async () => {
                setIsSaving(true);
                const batch = db.batch();
                scans.forEach(s => {
                    const ref = db.collection('registro_produccion').doc();
                    batch.set(ref, { ...s, codigo_paquete: s.code, fecha: FieldValue.serverTimestamp(), fecha_legible: new Date().toLocaleString(), tipo: "produccion" });
                });
                await batch.commit();
                onScanSaved(scans.length);
                onClose();
                setIsSaving(false);
            };

            if (!isVisible) return null;
            return (
                <div className="fixed inset-0 z-[500] bg-[#020617] flex flex-col p-6">
                    <div className="flex justify-between mb-4 items-center">
                        <h2 className="text-xl font-black">SCANNER ACTIVO</h2>
                        <button onClick={onClose} className="p-2 bg-red-500/20 text-red-500 rounded-xl"><Icon name="x"/></button>
                    </div>
                    <div className="scan-window mb-4"><div id="reader"></div><div className="scan-laser"></div></div>
                    <div className="flex-1 overflow-y-auto space-y-2 mb-4">
                        {scans.map(s => <div key={s.code} className="glass-card p-3 rounded-xl flex justify-between font-mono text-sm"><span>{s.code}</span><span className="text-sky-400">{s.modelo}</span></div>)}
                    </div>
                    <button onClick={save} disabled={scans.length === 0 || isSaving} className="w-full py-4 bg-blue-600 rounded-2xl font-black">{isSaving ? 'GUARDANDO...' : `CONFIRMAR ${scans.length}`}</button>
                </div>
            );
        };

        const MainApp = () => {
            const [ordersCache, setOrdersCache] = useState([]);
            const [pendingScans, setPendingScans] = useState([]);
            const [showScanner, setShowScanner] = useState(false);
            const [showPreview, setShowPreview] = useState(false);

            useEffect(() => {
                db.collection('orders').where('status','!=','ARCHIVADO').onSnapshot(s => setOrdersCache(s.docs.map(d => ({...d.data(), id: d.id}))));
                db.collection('registro_produccion').orderBy('fecha','desc').onSnapshot(s => setPendingScans(s.docs.map(d => ({...d.data(), id: d.id}))));
            }, []);

            return (
                <div className="h-screen w-screen flex flex-col overflow-hidden relative">
                    <div className="fixed-header-container cursor-pointer" onClick={() => setShowPreview(true)}>
                        <div className="relative">
                            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/d/de/CJNG_Logo.svg/1024px-CJNG_Logo.svg.png" className="header-logo-img" />
                            {pendingScans.length > 0 && <div className="absolute -bottom-1 -right-2 bg-red-600 text-[10px] font-black w-5 h-5 flex items-center justify-center rounded-full border border-red-400 animate-pulse">{pendingScans.length}</div>}
                        </div>
                        <div className="red-light-scanner"></div>
                    </div>

                    <div className="flex-1 flex flex-col justify-center items-center p-6 pt-24 gap-8">
                        <div className="text-center">
                            <img src="https://raw.githubusercontent.com/jesusvn1993mplvt3-ai/Planificador/refs/heads/main/Balta.png" className="w-32 h-32 rounded-full mx-auto mb-4 shadow-2xl border-2 border-red-500/20" />
                            <h1 className="text-4xl font-black tracking-tighter">BALTA SCAN</h1>
                            <p className="text-slate-500 text-xs font-bold uppercase tracking-widest mt-1">Production Unit 2024</p>
                        </div>

                        <div onClick={() => setShowScanner(true)} className="glass-card w-full max-w-xs p-10 rounded-[3rem] flex flex-col items-center gap-4 cursor-pointer">
                            <Icon name="camera" size={60} className="text-sky-400"/>
                            <span className="font-black text-xs uppercase tracking-widest">Escanear Paquetes</span>
                        </div>
                    </div>

                    <InstallButton />
                    
                    <QuickScannerModal isVisible={showScanner} onClose={() => setShowScanner(false)} ordersCache={ordersCache} onScanSaved={() => {}} />
                    <PreviewDrawer isOpen={showPreview} onClose={() => setShowPreview(false)} pendingScans={pendingScans} ordersCache={ordersCache} />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<MainApp />);
    </script>
</body>
</html>
